<!DOCTYPE html>
<html>
  <head>
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="js/react.js"></script>
    <script src="js/JSXTransformer.js"></script>
    <style type="text/css">
      body {
        font-family: Helvetica, Arial, sans-serif;
      }
      
      img.header {
        padding-left: 37px;
      }
      label.disabled {
        color: #ccc;
      }
      div#body {
        width: 500px;
        margin-left: auto;
        margin-right: auto;
      }
      div#form {
        border: 1px solid #ccc;
        border-radius: 12px;
        padding: 30px 40px;
        margin-top: 20px;
      }
      h1 {
        margin-top: 5px;
      }
      input[type="submit"] {
        border: 0;
        background: #68acdf;
        border-radius: 3px;
        padding: 8px 10px;
        font-size: 100%;
        color: white;
      }
      input[type="submit"]:disabled {
        background: #abcdef;
      }
    </style>
  </head>
  <body>
    <div id="body">
      <img class="header" src="http://techliminal.com/wp-content/themes/techliminal/assets/img/logo-web.png" />
      <div id="form"></div>
    </div>
    <script type="text/jsx">
      /** @jsx React.DOM */
      var emailValidator = /^([\w\!\#$\%\&\'\*\+\-\/\=\?\^\`{\|\}\~]+\.)*[\w\!\#$\%\&\'\*\+\-\/\=\?\^\`{\|\}\~]+@((((([a-z0-9]{1}[a-z0-9\-]{0,62}[a-z0-9]{1})|[a-z])\.)+[a-z]{2,6})|(\d{1,3}\.){3}\d{1,3}(\:\d{1,5})?)$/i;
      
      var SigninForm = React.createClass({
        getInitialState: function() {
          return { nameValue: "", emailValue: "", mailinglistValue: false, submitting: false };
        },

        postToMailchimp: function(cb) {
          var mcURL = "http://techliminal.us2.list-manage.com/subscribe/post?u=9cfb95a838ce41c6f0fdcdb50&id=1bb1c53ed3";
          $.ajax({
          	url: mcURL,
          	type:'POST',
          	data: {
          		EMAIL: this.state.emailValue
          	}
          }).always(cb);
        },
        
        updateForm: function(cb) {
          $.ajax({
            url: 'https://docs.google.com/forms/d/1Qis5HBQWdByhgU5S_kDzDRyUvnFLXTbzAeu0tJPWZfI/formResponse',
            method: "POST",
            data: {
              'entry.304838327': this.state.nameValue,
              'entry.1508544992': this.state.emailValue,
              'entry.2058622032': this.state.mailinglistValue ? 'Yes' : undefined
            }
          }).always(cb);
        },

        handleSignin: function(event) {
          this.setState({submitting: true});
          var self = this;
          this.updateForm(function() {
          	if (self.state.mailinglistValue) { 
              self.postToMailchimp(function() {
                self.setState(self.getInitialState());
                self.refs.name.getDOMNode().focus();
              });
            } else {
              self.setState(self.getInitialState());
              self.refs.name.getDOMNode().focus();              
            }
          });
          return false;
        },

        handleNameChange: function(event) {
          this.setState({ nameValue: event.target.value });
        },
        handleEmailChange: function(event) {
          this.setState({ emailValue: event.target.value });
        },
        handleCheckedChange: function(event) {
          this.setState({ mailinglistValue: event.target.checked });
        },
        
        render: function() {
          var validEmail = emailValidator.test(this.state.emailValue);
          var labelClass = validEmail ? "" : "disabled";
          var hasName = this.state.nameValue.length > 0;
          
          return <form onSubmit={this.handleSignin} onChange={this.onChange}>
            <h1>Welcome! Sign in:</h1>
            <p>Name: <input onChange={this.handleNameChange} type="text" ref="name" value={this.state.nameValue} disabled={this.state.submitting} /></p>
            <p>Email: <input onChange={this.handleEmailChange} type="text" value={this.state.emailValue} disabled={this.state.submitting} /></p>
            <p><label className={labelClass}><input type="checkbox" ref="mailinglist" disabled={this.state.submitting || ! validEmail} checked={this.state.mailinglistValue} onChange={this.handleCheckedChange} /> Yes, please sign me up for updates from Tech Liminal!</label></p>
            <p><input type="submit" value="Sign in!" disabled={this.state.submitting || ! hasName} /> {this.state.submitting ? <img src="/img/ajax-loader.gif" /> : ''}</p>
          </form>;
        }
      })
      React.renderComponent(
        <SigninForm />,
        document.getElementById('form')
      );
    </script>
  </body>
</html>
